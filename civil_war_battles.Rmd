---
title: "Civil War Battles"
author: "Logan Edmonds"
date: "December 23, 2016"
output: html_document
---

## TODO:

**GLOBAL PROBLEMS**:

 **geocoding**
 
  *We can use the Google Maps API through ggmap::geocode()*
-- approx. location based upon city/county
-- write.csv() to create new df with battle column?

 **verify geocoding**
-- check lat/long against limits of contiguous U.S.
-- possibly check each state against limits of state lat/long?

 **Weird Character Encodings**
-- '\x92', '\023', '\u0092', '<U+FFFD>'
-- What do these mean and can they be fixed in
   read_csv() function args?
-- UTC enconded?

 **How to split character list/matrix?**
-- str_split not working as anticipated
-- would like to have each commander a seperate element
   in each individual list
-- SO?
-- Jenny Bryan?

**VAR SPECIFIC PROBLEMS**:

 **battle**
-- Check for duplicates: duplicated() and unique() functions

 **other_names**
-- Determine number of other names contained in each row
    *str_count(other_names, ",") + 1*
    each other name is seperated by a comma, so the number of commas
    plus one will give us the number of other names
    
-- Split character vector into list with 4+ columns
-- Split based upon ','
-- What to do with 232 character string? ~ 11 'other names'

 **location_1**
-- PROBLEM: Can we geocode at county level with R?

  *Google Maps API and ggmap::geocode() in the clutch*

-- Only 29 values are not counties/parishes (i.e. Petersburg, VA)
  non_county <- 
    civil_war %>% 
      select(location_1) %>% 
      filter(!str_detect(location_1,"County|Parish"))

-- Many of the non-county level values are duplicated
  non_county %>% 
    filter(duplicated(.))

-- Remove White Space (i.e. Tampa , FL)
  str_detect(civil_war$location_1, "[:space:],[:space:]")

-- Recode values that can not be extracted from Google Maps API 
   through ggmap::geocode() 
   * 'Unknown, OK' = 'Yale, OK' (Battle of Round Mountain)
   * 'Unknown, OK' = 'Pontotoc County, OK' (Middle Boggy Depot Battle)
   * 'Pointe Coupe<e9> Parish, LA' = 'Pointe Coupee Parish, LA'   

 **location2:4**
-- Drop these vars?
-- OR geocode as well?

 **campaign Regex**
-- Remove (Month - Month Year) from end of string
-- Comment on Regex --> For future self!

## General Import and Basic Clean-Up

```{r package loads}
library(dplyr)
library(ggmap)
library(ggplot2)
library(lubridate)
library(readr)
library(stringr)
library(tidyr)
library(visdat)
```

```{r import data, cache = TRUE}
civil_war <- read_csv("civil_war_battle_summaries.csv")
```

```{r variable name lower case}
names(civil_war) <- str_to_lower(names(civil_war))
```


```{r remove unnecessary columns}
civil_war <-
  civil_war %>% 
    select( -c(`cwsac ref`, `preservation priority`, `national park unit`, 
               `start month`, `start day`, `start year`,
               `end month`, `end day`, `end year`,
               `nps site`, description, `forces engaged`)) 
```

```{r variable name string replacements}
# Using stringr package

names(civil_war) <- str_replace_all(names(civil_war), " ", "_")
names(civil_war) <- str_replace_all(names(civil_war), "\\.", "")
names(civil_war) <- str_replace_all(names(civil_war), "\\(s\\)", "s")
names(civil_war) <- str_replace_all(names(civil_war), "\\?", "")
```

```{r date vars}

# Select: rearranging vars into logical order
# Vars are easier to find

# Mutate: create POSIX date values

# Rename: # character requires ` ` escape in order to call var
civil_war <-
  civil_war %>% 
    select(battle:location_1, location_2:location_4,
           everything()) %>% 
    mutate(start_date = mdy(start_date),
           end_date = mdy(end_date)) %>% 
    rename(us_commanders = principal_us_commanders,
           cs_commanders = principal_cs_commanders,
           days_battle = `#_days_battle`,
           multiple_states = battle_in_multple_states)

# span <- interval(civil_war$start_date, civil_war$end_date)
```

## Glance at data and NA values

```{r NA values}
# We can see that a majority of other_names and location rows are NA's
# It is likely that the number of casualties that are NA's is higher
# Many casualties are coded as "Unknown", etc.

vis_miss(civil_war) + labs(x = "", y = "")
civil_war %>% summarise_each(funs(sum(is.na(.))))/nrow(civil_war) * 100

```


## Strings

```{r campaign strings - advanced regex}
# Removing (Month - Month, Year) from end of string
# See output below

head(civil_war$campaign)

head(str_replace_all(civil_war$campaign,
                     "[:space:]\\(.{0,30}\\)", ""))

civil_war$campaign <-
  str_replace_all(civil_war$campaign,
                  "[:space:]\\(.{0,30}\\)", "")

# Adding missing 'and'
civil_war$campaign <- 
  str_replace(civil_war$campaign, 
              ",[:space:]Ohio", ", and Ohio")

# Removing UTC miscoding
# \023 can not be encoded into R

civil_war$campaign[318] <- 
  "Richmond-Petersburg Campaign"

```

```{r location strings}
civil_war$location_1 <- 
  str_replace(civil_war$location_1, "[:space:],", ",")



```


```{r commanders strings}

# Remove unecessary [US] designations
# Note the use of escape characters for '[' and ']'
civil_war$us_commanders <- 
  str_replace(civil_war$us_commanders, 
              "[:space:]\\[US\\]", "")


# Repeat process for Confederate commanders
civil_war$cs_commanders <-
  str_replace(civil_war$cs_commanders, 
              "[:space:]\\[CS\\]", "")

# We need to  remove [I] for Indian commanders as well
# Or we could create 'indian_commander' var with 0/1 or "Yes"/"No"

# Split battles with two commanders into seperate vars
# Remove unecessary "and"

civil_war$cs_commanders <- 
  str_split(civil_war$cs_commanders, 
                  " and ", n = 2)

# Repeat process for Union commanders
civil_war$us_commanders <- 
  str_split(civil_war$us_commanders,
                  " and ", n = 2)

```

```{r results strings}
# Replace miscoded "Union Victory" value
# Now all results are Confederate/Union - "victory"
civil_war$results <- 
  str_replace(civil_war$results, "V", "v")
```

```{r casualties strings}

# Remove ',' that coerces NAs with as.numeric()
# 
civil_war$total_est_casualties <- 
  str_replace(civil_war$total_est_casualties,
              ",", "")

civil_war$us_est_casualties <- 
  str_replace(civil_war$us_est_casualties, 
              ",", "")

# 'I unknown' is equivalent to 'Indian casualties unknown'

civil_war$cs_est_casualties <- 
  str_replace_all(civil_war$cs_est_casualties, ",", "")
```

## Factors
```{r factoring variables, fig.height = 7, fig.width = 7}
civil_war$state <- factor(civil_war$state,
                          levels = names(sort(table(civil_war$state))))

civil_war$results <- factor(civil_war$results)

civil_war$multiple_states <- factor(civil_war$multiple_states)
```

```{r, battle states bar plot, eval = FALSE}
civil_war %>% count(state) %>% filter(n > 10)

civil_war %>% 
  ggplot(aes(x = state)) +
    geom_bar() +
    theme_classic() + 
    coord_flip() + # Swap x and y axes, so that state abbreviations are readable
    labs(x = "", y = "# Battles",
         title = "State Counts for\n Civil War Battle Sites")
```

## Geocoding

```{r cleanup for geocoding}

# Change 'Pointe Coup<e9> Parish, LA' to 'Pointe Coupee Parish, LA'
civil_war$location_1[str_detect(civil_war$location_1, "Pointe")] <- "Pointe Coupee Parish, LA"
# Change 'Unknown, OK' (Battle of Round Mountain) to 'Yale, OK'
civil_war$location_1[29] <- "Yale, OK"
# Change 'Unknown, OK' (Middle Boggy Depot Battle) to 'Pontotoc County, OK'
civil_war$location_1[227] <- "Pontotoc County, OK"
```

```{r ggmap::geocode() for geocoding by county/city name, cache = TRUE}
battle_latlong <- ggmap::geocode(civil_war$location_1)
```

## Mapping

```{r mapping battle points}
ggmap::qmplot(lon, lat, data = battle_latlong, col = "salmon")
USAMap <- ggmap(get_googlemap(center=usa_center, scale=2, zoom=4), extent="normal")
USAMap + geom_point(aes(x = lon, y = lat), data = battle_latlong, col = "blue", alpha = 0.6)
```

## Test Section

```{r duplicate value removal - battle var, eval = FALSE}
civil_war %>% filter(duplicated(civil_war$battle)) %>% print(n = nrow(.))
```

```{r string split - other_names var, eval = FALSE}
civil_war %>% filter(other_names != is.na(str_length(other_names))) %>% select(battle, other_names) %>% mutate(nchar = str_length(other_names))
```

```{r other names count}
other_name_counts <- 
  civil_war %>% 
    group_by(str_count(other_names, ",")) %>% 
    count()

other_name_counts <- 
  other_name_counts %>% 
    mutate(num_other_names = `str_count(other_names, ",")` + 1,
           count = n) %>% 
    select(num_other_names, count)

other_name_counts %>% 
  ggplot(aes(x = num_other_names, y = count)) +
    geom_histogram(stat = "identity") +
    scale_x_continuous(breaks = seq(1,11)) +
    theme_minimal() +
    labs(x = "Number of other names\n for battle")

```


